<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Reuniones Generales - U.E. "Dr. Camilo Gallegos Domínguez"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo para aplicar la fuente Inter y el fondo gradiente */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #FFFF00, #0000FF); /* Gradiente Amarillo a Azul */
            min-height: 100vh;
        }
        /* Contenedor principal con fondo semi-transparente */
        .content-container {
            background-color: rgba(255, 255, 255, 0.92); /* Fondo blanco ligeramente más opaco */
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 2rem auto; /* Centrado y con margen */
            max-width: 800px; /* Ancho máximo para mejor lectura */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        /* Estilos personalizados para botones */
        .btn {
            @apply inline-flex items-center justify-center px-5 py-2.5 rounded-lg font-semibold shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-pdf {
            background-color: #0056b3; /* Azul oscuro */
            color: white;
            border: 1px solid #004080;
        }
        .btn-pdf:hover {
            background-color: #003d80;
        }
        .btn-add {
            background-color: #28a745; /* Verde */
            color: white;
        }
        .btn-add:hover {
            background-color: #218838;
        }
        .btn-remove {
            background-color: #dc3545; /* Rojo */
            color: white;
            padding: 0.3rem 0.6rem; /* Más pequeño */
            font-size: 0.8rem;
        }
        .btn-remove:hover {
            background-color: #c82333;
        }
        /* Estilo para lista de orden del día */
        #agenda-list li {
            @apply flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200 mb-2;
        }
        /* Ocultar flechas en input number (si se usara) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex flex-col md:flex-row items-center justify-between bg-white bg-opacity-80 p-4 rounded-lg shadow-md mb-8 max-w-4xl mx-auto">
        <div class="flex items-center mb-4 md:mb-0">
            <img src="sello.jpg" alt="Sello Institución" class="h-16 w-16 md:h-20 md:w-20 mr-4 rounded-full border-2 border-blue-600" onerror="this.onerror=null; this.src='https://placehold.co/80x80/CCCCCC/000000?text=Error';">
            <h1 class="text-xl md:text-3xl font-bold text-blue-800">Unidad Educativa "Dr. Camilo Gallegos Domínguez"</h1>
        </div>
        <h2 class="text-lg md:text-2xl font-semibold text-yellow-600 text-center md:text-right">Registro de Reuniones Generales</h2>
    </header>

    <div class="content-container">
        <h3 class="text-2xl font-semibold mb-6 text-blue-700 border-b-2 border-yellow-400 pb-2">Detalles de la Reunión General</h3>
        <form id="meeting-form" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="meeting-date" class="block text-sm font-medium text-gray-700">Fecha y Hora:</label>
                    <input type="datetime-local" id="meeting-date" name="meeting-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="course-grade" class="block text-sm font-medium text-gray-700">Curso/Grado:</label>
                    <input type="text" id="course-grade" name="course-grade" required placeholder="Ej: Décimo EGB 'B'" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <div>
                <label for="teacher-name" class="block text-sm font-medium text-gray-700">Docente/Tutor Responsable:</label>
                <input type="text" id="teacher-name" name="teacher-name" required placeholder="Nombre del docente que convoca" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div class="border border-gray-300 p-4 rounded-lg bg-gray-50">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Orden del Día</h4>
                <div class="flex space-x-2 mb-3">
                    <input type="text" id="new-agenda-item" placeholder="Añadir punto al orden del día" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <button type="button" id="add-agenda-button" class="btn btn-add">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Añadir
                    </button>
                </div>
                <ul id="agenda-list" class="list-decimal list-inside space-y-1 max-h-40 overflow-y-auto bg-white p-3 rounded border">
                    <li id="no-agenda-items" class="text-gray-500 italic flex justify-center">No hay puntos añadidos.</li>
                </ul>
            </div>

            <div>
                <label for="meeting-development" class="block text-sm font-medium text-gray-700">Desarrollo de la Reunión:</label>
                <textarea id="meeting-development" name="meeting-development" rows="5" required placeholder="Detalle cómo se desarrollaron los puntos del orden del día, participaciones, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
            <div>
                <label for="agreements" class="block text-sm font-medium text-gray-700">Acuerdos y Compromisos Generales:</label>
                <textarea id="agreements" name="agreements" rows="4" required placeholder="Liste los acuerdos y compromisos establecidos para el curso/grupo." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
             <div>
                <label for="observations" class="block text-sm font-medium text-gray-700">Observaciones Adicionales:</label>
                <textarea id="observations" name="observations" rows="3" placeholder="Cualquier otra nota relevante sobre la reunión general." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>

            <div class="flex justify-end pt-4">
                <button type="button" id="pdf-button" class="btn btn-pdf w-full sm:w-auto">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                   </svg>
                    Guardar y Descargar PDF
                </button>
            </div>
        </form>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden px-4 z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">¡Éxito!</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message">El registro se ha generado correctamente.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-button" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        // Elementos del DOM
        const form = document.getElementById('meeting-form');
        const pdfButton = document.getElementById('pdf-button');
        const newAgendaItemInput = document.getElementById('new-agenda-item');
        const addAgendaButton = document.getElementById('add-agenda-button');
        const agendaList = document.getElementById('agenda-list');
        const noAgendaItemsMessage = document.getElementById('no-agenda-items');

        // Elementos del Modal
        const messageModal = document.getElementById('message-modal');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const closeModalButton = document.getElementById('close-modal-button');

        // Event listeners
        addAgendaButton.addEventListener('click', addAgendaItem);
        // Permitir añadir con Enter en el input
        newAgendaItemInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevenir envío de formulario (si lo hubiera)
                addAgendaItem();
            }
        });
        pdfButton.addEventListener('click', generateAndDownloadPDF);
        closeModalButton.addEventListener('click', closeModal);
        // Usar delegación de eventos para los botones de eliminar
        agendaList.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('remove-agenda-item')) {
                removeAgendaItem(event.target.parentElement);
            }
        });

        // --- Funciones de Agenda Editable ---

        function addAgendaItem() {
            const itemText = newAgendaItemInput.value.trim();
            if (itemText === '') {
                showModal('Entrada Vacía', 'Por favor, ingrese un punto para el orden del día.', false);
                return;
            }

            // Ocultar mensaje inicial si existe
            if (noAgendaItemsMessage) {
                noAgendaItemsMessage.style.display = 'none';
            }

            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span class="flex-grow mr-2">${itemText}</span>
                <button type="button" class="btn btn-remove remove-agenda-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Quitar
                </button>
            `;
            agendaList.appendChild(listItem);
            newAgendaItemInput.value = ''; // Limpiar input
            newAgendaItemInput.focus(); // Poner foco de nuevo en el input
        }

        function removeAgendaItem(itemElement) {
            itemElement.remove();
            // Mostrar mensaje si la lista queda vacía
            if (agendaList.children.length === 1 && noAgendaItemsMessage) { // Solo queda el mensaje original
                 agendaList.innerHTML = ''; // Limpiar por si acaso
                 agendaList.appendChild(noAgendaItemsMessage); // Volver a añadir el mensaje
                 noAgendaItemsMessage.style.display = 'list-item'; // Asegurarse que sea visible
            } else if (agendaList.children.length === 0 && noAgendaItemsMessage) {
                 // Si se eliminó el último item y el mensaje no estaba, volver a ponerlo
                 agendaList.appendChild(noAgendaItemsMessage);
                 noAgendaItemsMessage.style.display = 'list-item';
            }
        }

        function getAgendaItems() {
            const items = [];
            const listItems = agendaList.querySelectorAll('li:not(#no-agenda-items)'); // Excluir el mensaje
            listItems.forEach(li => {
                const span = li.querySelector('span');
                if (span) {
                    items.push(span.textContent.trim());
                }
            });
            return items;
        }

        // --- Funciones de PDF y Formulario ---

        function getFormData() {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                 if (key === 'meeting-date' && value) {
                    try {
                        const date = new Date(value);
                        data[key] = `${date.toLocaleDateString('es-EC')} ${date.toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' })}`;
                        data[`${key}_raw`] = value;
                    } catch (e) {
                        data[key] = value;
                    }
                } else {
                   data[key] = value.trim();
                }
            }
            data.agendaItems = getAgendaItems(); // Obtener los puntos del orden del día
            return data;
        }

        function validateForm(data) {
            const requiredFields = ['meeting-date', 'course-grade', 'teacher-name', 'meeting-development', 'agreements'];
            for (const field of requiredFields) {
                const valueToCheck = field === 'meeting-date' ? data[`${field}_raw`] : data[field];
                if (!valueToCheck) {
                    const inputElement = form.elements[field];
                    const label = inputElement ? inputElement.previousElementSibling?.textContent || field : field;
                    showModal('Campo Obligatorio', `El campo "${label.replace(':','')}" es obligatorio.`, false);
                    return false;
                }
            }
            // Validar que haya al menos un punto en el orden del día
            if (data.agendaItems.length === 0) {
                 showModal('Orden del Día Vacío', 'Debe añadir al menos un punto al Orden del Día.', false);
                 return false;
            }
            return true;
        }

        function generateAndDownloadPDF() {
            const meetingData = getFormData();

            if (!validateForm(meetingData)) {
                return; // Detener si la validación falla
            }

            generatePDF(meetingData); // Generar el PDF directamente

            // Opcional: Limpiar formulario después de generar PDF
            // form.reset();
            // agendaList.innerHTML = ''; // Limpiar lista
            // agendaList.appendChild(noAgendaItemsMessage); // Restaurar mensaje
            // noAgendaItemsMessage.style.display = 'list-item';

            showModal('¡Éxito!', 'El PDF del registro de la reunión ha sido generado.');
        }

        function generatePDF(data) {
            const doc = new jsPDF();
            const margin = 15;
            const lineHeight = 7;
            let currentY = margin;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();

            // Función para añadir nueva página si es necesario
            const checkNewPage = (heightNeeded = lineHeight * 2) => {
                if (currentY + heightNeeded > pageHeight - margin) {
                    doc.addPage();
                    currentY = margin;
                    // Opcional: Repetir encabezado simple en nuevas páginas
                    // doc.setFontSize(10);
                    // doc.setTextColor(150);
                    // doc.text(`Reunión General - ${data['course-grade']} - ${data['meeting-date'].split(' ')[0]}`, pageWidth - margin, margin / 2, { align: 'right' });
                    // currentY = margin; // Reset Y after potential header
                }
            };

            // --- Encabezado del PDF ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 180); // Azul oscuro
            doc.text('Acta de Reunión General de Padres de Familia', pageWidth / 2, currentY, { align: 'center' });
            currentY += lineHeight * 1.5;

            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100); // Gris
            doc.text('Unidad Educativa "Dr. Camilo Gallegos Domínguez"', pageWidth / 2, currentY, { align: 'center' });
            currentY += lineHeight * 2;

            // --- Información General ---
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0); // Negro

            const addLine = (label, value) => {
                checkNewPage();
                doc.setFont('helvetica', 'bold');
                doc.text(`${label}:`, margin, currentY);
                doc.setFont('helvetica', 'normal');
                const textLines = doc.splitTextToSize(value || '-', pageWidth - margin * 3 - doc.getTextWidth(label));
                doc.text(textLines, margin + doc.getTextWidth(label) + 2, currentY);
                currentY += (textLines.length * lineHeight) + (lineHeight / 2);
            };

            addLine('Fecha y Hora', data['meeting-date']);
            addLine('Curso/Grado', data['course-grade']);
            addLine('Docente/Responsable', data['teacher-name']);
            currentY += lineHeight; // Espacio extra

            // --- Orden del Día ---
            checkNewPage(lineHeight * (data.agendaItems.length + 2)); // Estimar espacio para el título y los items
            doc.setFont('helvetica', 'bold');
            doc.text('Orden del Día:', margin, currentY);
            currentY += lineHeight * 1.5;
            doc.setFont('helvetica', 'normal');
            data.agendaItems.forEach((item, index) => {
                checkNewPage();
                const itemText = `${index + 1}. ${item}`;
                const textLines = doc.splitTextToSize(itemText, pageWidth - margin * 2 - 10); // Ancho menos margen y numeración
                doc.text(textLines, margin + 5, currentY); // Indentado
                currentY += (textLines.length * lineHeight);
            });
            currentY += lineHeight; // Espacio después de la lista

            // --- Desarrollo, Acuerdos, Observaciones ---
             const addSection = (label, value) => {
                checkNewPage(lineHeight * 3); // Espacio para título y algo de texto
                doc.setFont('helvetica', 'bold');
                doc.text(`${label}:`, margin, currentY);
                currentY += lineHeight * 1.5;
                doc.setFont('helvetica', 'normal');
                const textLines = doc.splitTextToSize(value || '-', pageWidth - margin * 2);
                 // Iterar sobre las líneas para añadir y comprobar página
                textLines.forEach(line => {
                    checkNewPage();
                    doc.text(line, margin, currentY);
                    currentY += lineHeight;
                });
                currentY += lineHeight; // Espacio después de la sección
            };

            addSection('Desarrollo de la Reunión', data['meeting-development']);
            addSection('Acuerdos y Compromisos', data['agreements']);
            if (data['observations']) {
                addSection('Observaciones Adicionales', data['observations']);
            }

            // --- Firma del Responsable (Placeholder) ---
            checkNewPage(lineHeight * 4); // Espacio para firma
            currentY = pageHeight - margin * 3; // Posicionar firma cerca del final
            if (currentY < margin * 5) currentY = margin * 5; // Asegurar que no esté demasiado arriba si hay poco contenido

            const signatureX = pageWidth / 2;
            doc.setLineWidth(0.5);
            doc.line(margin, currentY, signatureX - margin, currentY); // Línea Firma
            doc.setFontSize(10);
            doc.text('Firma Docente/Responsable', margin, currentY + lineHeight);
            doc.text(data['teacher-name'], margin, currentY + lineHeight * 2);

            // --- Descargar el PDF ---
            const filename = `Acta_Reunion_General_${data['course-grade'].replace(/\s+/g, '_')}_${data['meeting-date'].split(' ')[0].replace(/\//g, '-')}.pdf`;
            doc.save(filename);
        }


        // --- Funciones del Modal ---
        function showModal(title, message, isSuccess = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.innerHTML = isSuccess
                ? `<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                : `<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            modalIcon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${isSuccess ? 'bg-green-100' : 'bg-red-100'}`;
            messageModal.classList.remove('hidden');
        }

        function closeModal() {
            messageModal.classList.add('hidden');
        }

    </script>

</body>
</html>
