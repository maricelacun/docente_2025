<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario de Clases - Unidad Educativa Dr. Camilo Gallegos Domínguez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Graduate&display=swap" rel="stylesheet">
    <style>
        /* Estilo para el cuerpo con degradado radial */
        body {
            font-family: "Inter", sans-serif; /* Fuente principal */
            background: radial-gradient(circle, rgba(255, 255, 0, 0.6), rgba(0, 0, 255, 0.6)); /* Amarillo a Azul */
            min-height: 100vh; /* Asegura que el degradado cubra toda la altura */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea al inicio para ver el contenido desde arriba */
            padding-top: 1.5rem; /* Reduce espacio superior */
            padding-bottom: 1.5rem; /* Reduce espacio inferior */
        }

        /* Estilos específicos para la fuente del título */
        .font-graduate {
            font-family: 'Graduate', serif;
        }

        /* Estilos para la impresión */
        @media print {
             @page {
                size: landscape; /* Orientación horizontal para impresión */
                margin: 5mm; /* Márgenes de impresión REDUCIDOS */
            }
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: none; /* Sin fondo en impresión */
                font-size: 11pt; /* Tamaño de fuente base REDUCIDO para impresión */
                line-height: 1.5; /* Reduce interlineado */
                -webkit-print-color-adjust: exact !important; /* Mantiene colores en Chrome/Safari */
                print-color-adjust: exact !important; /* Mantiene colores en Firefox */
            }


            #schedule-container {
                box-shadow: none !important;
                background: white !important;
            }

            .view-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
                border-bottom: 1px solid #ccc;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .header-logo-container,
            .header-tic-container {
                flex: 0 0 auto;
            }

            .header-text-container {
                flex-grow: 1;
                text-align: center;
                margin: 0 10px;
            }

            img {
                max-width: 100%;
                height: auto;
            }


            /* Oculta botones y elementos no deseados al imprimir */
            .no-print {
                display: none !important;
            }
            /* Ajusta el contenedor para impresión */
            #schedule-container {
                margin: 0 auto; /* Centra el contenedor */
                padding: 0;
                border: none;
                box-shadow: none;
                width: 100%; /* Ocupa el ancho disponible */
                max-width: 100%; /* Evita que se exceda */
                background: none;
                backdrop-filter: none;
            }
            /* Asegura que la tabla use el ancho disponible */
            table {
                width: 100% !important;
                table-layout: fixed; /* Ayuda a controlar el ancho de las columnas */
                font-size: 7.5pt; /* Tamaño de fuente más pequeño para impresión */
                border-collapse: collapse !important; /* Asegura bordes colapsados */
            }
            th, td {
                border: 1px solid #555 !important; /* Bordes más visibles en impresión */
                padding: 2px; /* Reduce el padding AÚN MÁS para impresión */
                word-wrap: break-word; /* Permite que el texto largo se ajuste */
                vertical-align: middle;
                text-align: center;
            }
            th {
                background-color: #e0e7ff !important; /* Fondo claro para encabezados */
                color: #1e3a8a !important; /* Color de texto */
                font-weight: 600 !important;
                padding: 3px 2px; /* Ajuste padding encabezado */
            }
            /* Estilo para la fila de receso */
            .recess-row th, .recess-row td {
                background-color: #fef3c7 !important; /* Similar a bg-yellow-100 */
                color: #92400e !important; /* Similar a text-yellow-800 */
                font-weight: 600 !important;
            }

            /* --- AJUSTES HEADER PARA IMPRESIÓN --- */
            header.view-header { /* Apunta al header específico */
                display: flex !important;
                justify-content: space-between !important; /* Sello Izquierda, Texto Centro, TIC Derecha */
                align-items: center !important;
                border-bottom: 1px solid #ccc !important;
                margin-bottom: 0.5rem !important; /* Reduce margen inferior header */
                padding-bottom: 0.5rem !important; /* Reduce padding inferior header */
                width: 100% !important; /* Asegura ancho completo */
            }
            /* Contenedor del logo (izquierda) */
            .header-logo-container {
                flex-shrink: 0; /* No se encoge */
                margin-right: 5px !important; /* Pequeño margen derecho */
            }
            .header-logo-container img {
                max-width: 45px !important; /* Tamaño logo MÁS reducido */
                max-height: 45px !important;
                display: block !important; /* Asegura que sea bloque */
            }
            /* Contenedor del texto (centro) */
            .header-text-container {
                flex-grow: 1; /* Ocupa el espacio restante */
                text-align: center !important;
                padding: 0 5px; /* Añade un poco de padding lateral */
            }
            header h1 { font-size: 10pt !important; margin-bottom: 0 !important; }
            header h2 { font-size: 12pt !important; margin-bottom: 2px !important; }
            header p { font-size: 9pt !important; margin-top: 0 !important; }

            /* Contenedor imagen TIC (derecha) - Asegura que sea visible */
            .header-tic-container {
                flex-shrink: 0; /* No se encoge */
                margin-left: 5px !important; /* Pequeño margen izquierdo */
            }
            .header-tic-container img { /* Apunta a la imagen dentro del contenedor */
                display: block !important; /* Asegura que sea visible */
                max-width: 45px !important; /* Mismo tamaño reducido que el logo */
                max-height: 45px !important;
                object-fit: cover; /* Ajusta la imagen */
            }
            /* Oculta la clase original si aún existe, aunque es mejor quitarla del HTML */
            .print-hide-image {
                /* display: none !important; Ya no es necesario si la movemos */
            }
            /* --- FIN AJUSTES HEADER --- */


            /* Estilo para selectores en impresión (muestra el valor seleccionado) */
            select {
                border: none !important;
                background: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                padding: 1px !important; /* Padding mínimo */
                font-size: inherit !important; /* Hereda tamaño de fuente de la celda */
                color: inherit !important; /* Hereda color de texto */
                width: 100%; /* Ocupa el espacio de la celda */
                text-align: center; /* Centra el texto seleccionado */
                line-height: 1; /* Ajusta interlineado del select */
            }
            /* Oculta la flecha del select en impresión */
            select::-ms-expand { display: none; } /* IE/Edge */

            /* Título principal del horario */
            h3 {
                font-size: 11pt !important;
                margin-bottom: 0.5rem !important; /* Reduce margen inferior título */
            }
            /* Reduce tamaño de fuente de las horas editables */
            .time-slot {
                font-size: 6.5pt !important;
            }
        }

        /* Estilo para la tabla (vista normal) */
        table {
            border-collapse: collapse; /* Colapsa los bordes */
            width: 100%;
            table-layout: fixed; /* Distribución uniforme de columnas */
        }
        th, td {
            border: 1px solid rgba(0, 0, 0, 0.2); /* Bordes sutiles */
            text-align: center;
            padding: 6px; /* Espaciado interno ajustado */
            vertical-align: middle; /* Alineación vertical */
        }
        th {
            background-color: rgba(219, 234, 254, 0.8); /* Fondo azul claro semi-transparente */
            font-weight: 600;
            color: #1e3a8a; /* Azul oscuro para texto de encabezado */
            padding: 8px 6px; /* Padding encabezado normal */
        }
        /* Estilo para los selectores (vista normal) */
        td select {
            width: 100%;
            padding: 5px 4px; /* Padding ajustado */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 0.8rem; /* Tamaño fuente select reducido */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            -webkit-appearance: none; /* Quita apariencia nativa en Webkit */
            -moz-appearance: none; /* Quita apariencia nativa en Firefox */
            appearance: none; /* Quita apariencia nativa estándar */
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.4rem center;
            background-size: 1em;
            padding-right: 1.8rem; /* Espacio para la flecha */
        }
        td select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5); /* Borde azul al enfocar */
            background-color: rgba(255, 255, 255, 0.4);
        }
        /* Estilo para la fila de receso */
        .recess-row th, .recess-row td {
            background-color: rgba(254, 243, 199, 0.8) !important; /* bg-yellow-100 con opacidad */
            color: #92400e !important; /* text-yellow-800 */
            font-weight: 600 !important;
        }
        /* Ajuste tamaño fuente horas editables (vista normal) */
        .time-slot {
            font-size: 0.7rem; /* Tamaño reducido */
        }
        /* Estilos Header Vista Normal (Flexbox para consistencia) */
        header.view-header {
            display: flex;
            flex-direction: column; /* Apilado por defecto */
            align-items: center; /* Centrado por defecto */
            text-align: center;
            border-bottom: 1px solid #ccc; /* Borde inferior */
            padding-bottom: 0.75rem; /* Espaciado inferior */
            margin-bottom: 1rem; /* Margen inferior */
        }
        @media (min-width: 768px) { /* md breakpoint */
            header.view-header {
                flex-direction: row; /* Fila en pantallas medianas y grandes */
                justify-content: space-between;
                text-align: left;
            }
            .view-header .header-text-container {
                text-align: center; /* Mantiene texto centrado incluso en fila */
                flex-grow: 1; /* Permite que ocupe espacio */
                margin: 0 1rem; /* Margen horizontal */
            }
            .view-header .header-logo-container {
                margin-bottom: 0; /* Quita margen inferior en vista de fila */
                flex-shrink: 0; /* Evita que se encoja */
            }
             .view-header .header-tic-container {
                margin-top: 0; /* Quita margen superior en vista de fila */
                 flex-shrink: 0; /* Evita que se encoja */
            }
        }

    </style>
</head>
<body class="p-4 md:p-6">

    <div id="schedule-container" class="max-w-6xl w-full mx-auto bg-white bg-opacity-80 backdrop-blur-sm p-4 md:p-6 rounded-lg shadow-xl">

        <header class="view-header">
            <div class="header-logo-container flex items-center space-x-3 mb-3 md:mb-0 flex-shrink-0">
                <img src="sello.jpg" alt="Sello del Colegio" class="w-14 h-14 md:w-16 md:h-16 rounded-full object-cover border-2 border-blue-200" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e2e8f0/64748b?text=Sello';">
            </div>
            <div class="header-text-container">
                <h1 class="text-base md:text-xl font-bold text-blue-800 font-graduate">UNIDAD EDUCATIVA</h1>
                <h2 class="text-xl md:text-2xl font-bold text-blue-900 font-graduate">DR. CAMILO GALLEGOS DOMINGUEZ</h2>
                <p class="text-sm md:text-lg text-blue-700 mt-1">Tutor/a: Msc. Maricela Cun Rueda</p>
            </div>
            <div class="header-tic-container flex-shrink-0 mt-3 md:mt-0">
                <img src="tic.jpg" alt="Imagen TIC" class="w-28 h-auto md:w-32 rounded-md object-cover shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/128/dbeafe/1e3a8a?text=TIC+Error';">
            </div>
        </header>

        <h3 class="text-xl font-semibold text-center text-gray-800 mb-4">Horario de Clases</h3>

        <div class="overflow-x-auto mb-4">
            <table id="schedule-table" class="min-w-full bg-white bg-opacity-90 rounded-md shadow">
                <thead class="bg-blue-100">
                    <tr>
                        <th class="w-[10%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Hora</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Lunes</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Martes</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Miércoles</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Jueves</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Viernes</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 text-xs">
                    <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 1 <br><span contenteditable="true" class="font-normal time-slot">(12:40-13:20)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                    <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 2 <br><span contenteditable="true" class="font-normal time-slot">(13:20-14:00)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 3 <br><span contenteditable="true" class="font-normal time-slot">(14:00-14:40)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 4 <br><span contenteditable="true" class="font-normal time-slot">(14:40-15:20)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                    <tr class="recess-row">
                        <th scope="row" class="font-semibold py-2 px-1">RECESO <br><span contenteditable="true" class="font-normal time-slot">(15:20-15:50)</span></th>
                        <td colspan="5" class="text-center font-semibold py-2 px-1">TIEMPO DE DESCANSO ESTUDIANTIL</td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 5 <br><span contenteditable="true" class="font-normal time-slot">(15:50-16:30)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 6 <br><span contenteditable="true" class="font-normal time-slot">(16:30-17:10)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 7 <br><span contenteditable="true" class="font-normal time-slot">(17:10-17:50)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 8 <br><span contenteditable="true" class="font-normal time-slot">(17:50-18:30)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4 mt-4 no-print">
            <button id="download-excel" class="w-full sm:w-auto bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center space-x-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span>Descargar Excel</span>
            </button>
            <button id="print-schedule" class="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center space-x-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    <path d="M7 11h6v1H7v-1z"/>
                </svg>
                <span>Imprimir Horario</span>
            </button>
        </div>

    </div>

   <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Selección de elementos del DOM (tu código existente)
            const scheduleContainer = document.getElementById('schedule-container');
            const downloadExcelButton = document.getElementById('download-excel');
            const printButton = document.getElementById('print-schedule');
            const subjectSelects = document.querySelectorAll('select.subject-select');
            const editableTimeSlots = document.querySelectorAll('.time-slot');
            const scheduleTable = document.getElementById('schedule-table');
            const headerElement = document.querySelector('header.view-header');

            console.log("Botón Descargar Excel encontrado:", downloadExcelButton);

            // --- Opciones para los menús desplegables --- (tu código existente)
            const subjectOptions = [
                "", // Opción vacía por defecto
                "Programación Y bases de datos \"A\"",
                "Programación y Bases de datos \"B\"",
                "Soporte Técnico \"A\"",
                "Soporte Técnico \"B\"",
                "Sistema Operativo y Redes \"A\"",
                "Sistema Operativo y Redes \"B\"",
                "Acompañamiento Integral"
            ];

            // --- Poblar los menús desplegables y cargar/guardar selección --- (tu código existente)
            subjectSelects.forEach((selectElement, index) => {
                // ... (tu código para poblar los select y guardar/cargar en localStorage) ...
                 // Tu código existente para poblar opciones y manejar localStorage va aquí
                 subjectOptions.forEach(optionText => {
                     const option = document.createElement('option');
                     option.value = optionText;
                     option.textContent = optionText || "--- Seleccionar ---";
                     selectElement.appendChild(option);
                 });
                 selectElement.id = `select_cell_${index}`; // ID único
                 const savedValue = localStorage.getItem(selectElement.id); // Cargar valor
                 if (savedValue) {
                     selectElement.value = savedValue;
                 }
                 selectElement.addEventListener('change', () => { // Guardar al cambiar
                     localStorage.setItem(selectElement.id, selectElement.value);
                 });
            });

            // --- Guardar/Cargar horas editables --- (Añadir si no lo tienes)
            function saveTimeSlots() {
                editableTimeSlots.forEach((span, index) => {
                    span.id = `time_slot_${index}`;
                    localStorage.setItem(span.id, span.textContent);
                });
                console.log("Horas guardadas en localStorage.");
            }
            function loadTimeSlots() {
                editableTimeSlots.forEach((span, index) => {
                    span.id = `time_slot_${index}`;
                    const savedTime = localStorage.getItem(span.id);
                    if (savedTime) {
                        span.textContent = savedTime;
                    }
                    // Guardar al perder el foco (cuando se termina de editar)
                    span.addEventListener('blur', () => {
                        localStorage.setItem(span.id, span.textContent);
                        console.log(`Hora ${span.id} actualizada.`);
                    });
                });
                console.log("Horas cargadas de localStorage.");
            }
            loadTimeSlots(); // Cargar horas al inicio


            // --- Funcionalidad del Botón Descargar Excel --- (CÓDIGO CORREGIDO Y COMPLETADO)
            if (downloadExcelButton) {
                console.log("Añadiendo event listener al botón Descargar Excel.");
                downloadExcelButton.addEventListener('click', () => {
                    console.log('¡Clic detectado en Descargar Excel!');

                    // Verificar si la librería XLSX está cargada
                    if (typeof XLSX === 'undefined') {
                        console.error("Error: La librería SheetJS (XLSX) no se ha cargado correctamente.");
                        alert("Error: No se pudo encontrar la librería necesaria para generar el archivo Excel. Revise la conexión a internet o la consola para errores de carga.");
                        return;
                    } else {
                        console.log("Librería XLSX encontrada.");
                    }

                    // ** Añadido Try...Catch para manejo de errores **
                    try {
                        console.log('Iniciando proceso de exportación a Excel...');

                         // ** Asegurarse de guardar las horas editadas MÁS RECIENTES antes de exportar **
                         saveTimeSlots(); // Llamar a la función para guardar las horas

                        // --- Preparar datos para la hoja de cálculo ---
                        const data = [];
                        console.log('Array de datos inicializado.');

                        // 1. Añadir Encabezado (Títulos, Tutor, etc.)
                        // ... (tu código existente para extraer h1, h2, p, h3) ...
                         const headerTextContainer = headerElement?.querySelector('.header-text-container');
                         const h1Text = headerTextContainer?.querySelector('h1')?.textContent.trim() || '';
                         const h2Text = headerTextContainer?.querySelector('h2')?.textContent.trim() || '';
                         const pText = headerTextContainer?.querySelector('p')?.textContent.trim() || '';
                         const scheduleTitle = scheduleContainer.querySelector('h3')?.textContent.trim() || 'Horario de Clases';
                         console.log('Encabezado extraído:', h1Text, h2Text, pText, scheduleTitle);

                         data.push([h1Text]);
                         data.push([h2Text]);
                         data.push([pText]);
                         data.push([]); // Fila vacía de separación
                         data.push([scheduleTitle]);
                         data.push([]); // Fila vacía de separación
                         console.log('Datos del encabezado añadidos al array.');

                        // 2. Añadir Cabecera de la Tabla (Hora, Lunes, Martes...)
                        const headerRow = [];
                        // ... (tu código existente para extraer th del thead) ...
                         if (!scheduleTable || !scheduleTable.tHead) {
                             console.error("Error: No se encontró la tabla o su encabezado (thead).");
                             alert("Error al procesar la tabla para Excel.");
                             return;
                         }
                         scheduleTable.tHead.querySelectorAll('th').forEach(th => {
                             // Limpiar texto y quitar saltos de línea innecesarios para Excel
                             const cleanText = th.textContent.replace(/\s+/g, ' ').trim();
                             headerRow.push(cleanText);
                         });
                         if (headerRow.length > 0) {
                             data.push(headerRow);
                             console.log('Cabecera de tabla añadida:', headerRow);
                         } else {
                             console.error("No se pudo extraer la cabecera de la tabla.");
                             alert("Error al procesar la cabecera de la tabla para Excel.");
                             return;
                         }

                        // 3. Añadir Filas de Datos de la Tabla (tbody)
                         if (!scheduleTable.tBodies || scheduleTable.tBodies.length === 0) {
                             console.warn("Advertencia: No se encontró el cuerpo (tbody) de la tabla.");
                         }
                         const tableBodyRows = scheduleTable.tBodies[0]?.querySelectorAll('tr') || [];
                         console.log(`Procesando ${tableBodyRows.length} filas del tbody.`);

                         if (tableBodyRows.length === 0) {
                             console.warn("El cuerpo de la tabla está vacío.");
                         }

                        // ... (tu código existente para iterar tr, th, td y extraer datos de select/text) ...
                         tableBodyRows.forEach((tr, rowIndex) => {
                             const rowData = [];
                             const th = tr.querySelector('th'); // Celda de la hora (encabezado de fila)

                             if (th) {
                                 const hourTextNodes = Array.from(th.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
                                 const hourText = hourTextNodes.map(node => node.textContent.trim()).join(' ').trim();
                                 const timeSlotSpan = th.querySelector('.time-slot');
                                 const timeText = timeSlotSpan ? timeSlotSpan.textContent.trim() : '';
                                 rowData.push(`${hourText} ${timeText}`); // Combinar Hora y Rango
                             } else {
                                 rowData.push(''); // Celda vacía si no hay 'th'
                             }

                             const tds = tr.querySelectorAll('td'); // Celdas de datos (Lunes a Viernes)
                             tds.forEach((td) => {
                                 if (td.colSpan && td.colSpan > 1) { // Manejar celdas con colspan (como el receso)
                                     rowData.push(td.textContent.trim());
                                     // Añadir celdas vacías para las columnas restantes que abarca el colspan
                                     for (let i = 1; i < td.colSpan; i++) {
                                         rowData.push("");
                                     }
                                 } else {
                                     const select = td.querySelector('select.subject-select');
                                     if (select) { // Si la celda contiene un select
                                         const selectedOption = select.options[select.selectedIndex];
                                         const selectedText = selectedOption ? selectedOption.text : '';
                                         // Exportar vacío si es la opción por defecto, sino el texto seleccionado
                                         rowData.push(selectedText === "--- Seleccionar ---" ? "" : selectedText);
                                     } else { // Si es una celda normal (aunque en tu ejemplo no hay)
                                         rowData.push(td.textContent.trim());
                                     }
                                 }
                             });

                             // Asegurarse de que la fila tenga el número correcto de columnas
                             const expectedColumns = headerRow.length;
                             while (rowData.length < expectedColumns) {
                                 rowData.push(''); // Rellenar con vacíos si faltan columnas
                             }
                             // Solo añadir la fila si contiene algún dato (evita filas completamente vacías si las hubiera)
                             if(rowData.some(cell => cell !== '')) {
                                 data.push(rowData);
                             }
                             // console.log(`Fila ${rowIndex} procesada:`, rowData); // Descomentar para debug detallado
                         });

                        console.log('Datos de las filas procesados.');

                        // Verificar si hay datos para exportar además del encabezado
                        const headerRowCount = 6; // Número de filas del encabezado + separadores
                         const dataRowCount = data.length - headerRowCount -1; // -1 por la fila de cabecera de tabla
                        if (dataRowCount <= 0) { // Si no hay filas de datos reales
                            console.warn("No se encontraron datos en las filas del horario para exportar.");
                            alert("El horario parece estar vacío o no se pudo leer la información. No se generó el archivo Excel.");
                            return;
                        }


                        // --- Crear Hoja de Cálculo (Worksheet) ---
                        console.log('Creando hoja de cálculo...');
                        const worksheet = XLSX.utils.aoa_to_sheet(data);
                        console.log('Hoja de cálculo creada.');

                         // --- (INICIO) CÓDIGO FALTANTE AÑADIDO ---

                         // --- Ajustar ancho de columnas (opcional pero recomendado) ---
                         // Calcula el ancho máximo necesario para cada columna basado en el contenido
                         const columnWidths = data[0].map((_, colIndex) => {
                             let maxWidth = 0;
                             data.forEach(row => {
                                 const cellValue = row[colIndex] ? String(row[colIndex]) : '';
                                 // Dividir por saltos de línea si existen y tomar la línea más larga
                                 const lines = cellValue.split('\n');
                                 lines.forEach(line => {
                                     maxWidth = Math.max(maxWidth, line.length);
                                 });
                             });
                             // Añadir un poco de espacio extra, limitar a un máximo razonable
                             return { wch: Math.min(Math.max(maxWidth + 2, 10), 50) };
                         });
                         worksheet['!cols'] = columnWidths;
                         console.log('Ancho de columnas ajustado:', columnWidths);

                         // --- Crear Libro de Trabajo (Workbook) ---
                         console.log('Creando libro de trabajo...');
                         const workbook = XLSX.utils.book_new();
                         console.log('Libro de trabajo creado.');

                         // --- Añadir la Hoja de Cálculo al Libro ---
                         // El primer argumento es el libro, el segundo la hoja, el tercero el nombre de la pestaña
                         XLSX.utils.book_append_sheet(workbook, worksheet, "Horario");
                         console.log('Hoja añadida al libro con nombre "Horario".');

                         // --- Generar y Descargar el Archivo Excel ---
                         const fileName = "Horario_Clases.xlsx"; // Nombre del archivo
                         console.log(`Iniciando descarga del archivo: ${fileName}`);
                         XLSX.writeFile(workbook, fileName);
                         console.log('Descarga del archivo Excel iniciada.');

                         // --- (FIN) CÓDIGO FALTANTE AÑADIDO ---

                    } catch (error) {
                        // Capturar cualquier error durante el proceso
                        console.error("Error durante la generación o descarga del Excel:", error);
                        alert("Ocurrió un error al intentar generar el archivo Excel. Por favor, revisa la consola del navegador (F12) para más detalles.");
                    }
                });
            } else {
                console.error("Error: No se encontró el botón con id 'download-excel'.");
                alert("Error crítico: El botón para descargar Excel no se pudo encontrar en la página.");
            }

            // --- Funcionalidad del Botón Imprimir --- (Tu código existente)
            if (printButton) {
                printButton.addEventListener('click', () => {
                    console.log('Clic en Imprimir Horario');
                    // Guardar las selecciones antes de imprimir (por si acaso)
                    subjectSelects.forEach(selectElement => {
                        localStorage.setItem(selectElement.id, selectElement.value);
                    });
                    saveTimeSlots(); // Guardar horas editables también
                    window.print(); // Abre el diálogo de impresión del navegador
                });
            } else {
             console.error("Error: No se encontró el botón con id 'print-schedule'.");
          }

        });
    </script>

</body>
</html>
