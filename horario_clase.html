<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario de Clases - Unidad Educativa Dr. Camilo Gallegos Domínguez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbOBVEkls1ZHauBEHBPbBXZcvWHDRbyZaGFUdTIAAE/BFVnX8/M+sKGYRfMvDCDxARZmkBflF/Yw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Graduate&display=swap" rel="stylesheet">
    <style>
        /* Estilo para el cuerpo con degradado radial */
        body {
            font-family: "Inter", sans-serif; /* Fuente principal */
            background: radial-gradient(circle, rgba(255, 255, 0, 0.6), rgba(0, 0, 255, 0.6)); /* Amarillo a Azul */
            min-height: 100vh; /* Asegura que el degradado cubra toda la altura */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea al inicio para ver el contenido desde arriba */
            padding-top: 1.5rem; /* Reduce espacio superior */
            padding-bottom: 1.5rem; /* Reduce espacio inferior */
        }

        /* Estilos específicos para la fuente del título */
        .font-graduate {
            font-family: 'Graduate', serif;
        }

        /* Estilos para la impresión */
        @media print {
             @page {
                size: landscape; /* Orientación horizontal para impresión */
                margin: 5mm; /* Márgenes de impresión REDUCIDOS */
            }
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: none; /* Sin fondo en impresión */
                font-size: 11pt; /* Tamaño de fuente base REDUCIDO para impresión */
                line-height: 1.5; /* Reduce interlineado */
                -webkit-print-color-adjust: exact !important; /* Mantiene colores en Chrome/Safari */
                print-color-adjust: exact !important; /* Mantiene colores en Firefox */
            }


            #schedule-container {
                box-shadow: none !important;
                background: white !important;
            }

            .view-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
                border-bottom: 1px solid #ccc;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .header-logo-container,
            .header-tic-container {
                flex: 0 0 auto;
            }

            .header-text-container {
                flex-grow: 1;
                text-align: center;
                margin: 0 10px;
            }

            img {
                max-width: 100%;
                height: auto;
            }


            /* Oculta botones y elementos no deseados al imprimir */
            .no-print {
                display: none !important;
            }
            /* Ajusta el contenedor para impresión */
            #schedule-container {
                margin: 0 auto; /* Centra el contenedor */
                padding: 0;
                border: none;
                box-shadow: none;
                width: 100%; /* Ocupa el ancho disponible */
                max-width: 100%; /* Evita que se exceda */
                background: none;
                backdrop-filter: none;
            }
            /* Asegura que la tabla use el ancho disponible */
            table {
                width: 100% !important;
                table-layout: fixed; /* Ayuda a controlar el ancho de las columnas */
                font-size: 7.5pt; /* Tamaño de fuente más pequeño para impresión */
                border-collapse: collapse !important; /* Asegura bordes colapsados */
            }
            th, td {
                border: 1px solid #555 !important; /* Bordes más visibles en impresión */
                padding: 2px; /* Reduce el padding AÚN MÁS para impresión */
                word-wrap: break-word; /* Permite que el texto largo se ajuste */
                vertical-align: middle;
                text-align: center;
            }
            th {
                background-color: #e0e7ff !important; /* Fondo claro para encabezados */
                color: #1e3a8a !important; /* Color de texto */
                font-weight: 600 !important;
                padding: 3px 2px; /* Ajuste padding encabezado */
            }
            /* Estilo para la fila de receso */
            .recess-row th, .recess-row td {
                background-color: #fef3c7 !important; /* Similar a bg-yellow-100 */
                color: #92400e !important; /* Similar a text-yellow-800 */
                font-weight: 600 !important;
            }

            /* --- AJUSTES HEADER PARA IMPRESIÓN --- */
            header.view-header { /* Apunta al header específico */
                display: flex !important;
                justify-content: space-between !important; /* Sello Izquierda, Texto Centro, TIC Derecha */
                align-items: center !important;
                border-bottom: 1px solid #ccc !important;
                margin-bottom: 0.5rem !important; /* Reduce margen inferior header */
                padding-bottom: 0.5rem !important; /* Reduce padding inferior header */
                width: 100% !important; /* Asegura ancho completo */
            }
            /* Contenedor del logo (izquierda) */
            .header-logo-container {
                flex-shrink: 0; /* No se encoge */
                margin-right: 5px !important; /* Pequeño margen derecho */
            }
            .header-logo-container img {
                max-width: 45px !important; /* Tamaño logo MÁS reducido */
                max-height: 45px !important;
                display: block !important; /* Asegura que sea bloque */
            }
            /* Contenedor del texto (centro) */
            .header-text-container {
                flex-grow: 1; /* Ocupa el espacio restante */
                text-align: center !important;
                padding: 0 5px; /* Añade un poco de padding lateral */
            }
            header h1 { font-size: 10pt !important; margin-bottom: 0 !important; }
            header h2 { font-size: 12pt !important; margin-bottom: 2px !important; }
            header p { font-size: 9pt !important; margin-top: 0 !important; }

            /* Contenedor imagen TIC (derecha) - Asegura que sea visible */
            .header-tic-container {
                flex-shrink: 0; /* No se encoge */
                margin-left: 5px !important; /* Pequeño margen izquierdo */
            }
            .header-tic-container img { /* Apunta a la imagen dentro del contenedor */
                display: block !important; /* Asegura que sea visible */
                max-width: 45px !important; /* Mismo tamaño reducido que el logo */
                max-height: 45px !important;
                object-fit: cover; /* Ajusta la imagen */
            }
            /* Oculta la clase original si aún existe, aunque es mejor quitarla del HTML */
            .print-hide-image {
                /* display: none !important; Ya no es necesario si la movemos */
            }
            /* --- FIN AJUSTES HEADER --- */


            /* Estilo para selectores en impresión (muestra el valor seleccionado) */
            select {
                border: none !important;
                background: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                padding: 1px !important; /* Padding mínimo */
                font-size: inherit !important; /* Hereda tamaño de fuente de la celda */
                color: inherit !important; /* Hereda color de texto */
                width: 100%; /* Ocupa el espacio de la celda */
                text-align: center; /* Centra el texto seleccionado */
                line-height: 1; /* Ajusta interlineado del select */
            }
            /* Oculta la flecha del select en impresión */
            select::-ms-expand { display: none; } /* IE/Edge */

            /* Título principal del horario */
            h3 {
                font-size: 11pt !important;
                margin-bottom: 0.5rem !important; /* Reduce margen inferior título */
            }
            /* Reduce tamaño de fuente de las horas editables */
            .time-slot {
                font-size: 6.5pt !important;
            }
        }

        /* Estilo para la tabla (vista normal) */
        table {
            border-collapse: collapse; /* Colapsa los bordes */
            width: 100%;
            table-layout: fixed; /* Distribución uniforme de columnas */
        }
        th, td {
            border: 1px solid rgba(0, 0, 0, 0.2); /* Bordes sutiles */
            text-align: center;
            padding: 6px; /* Espaciado interno ajustado */
            vertical-align: middle; /* Alineación vertical */
        }
        th {
            background-color: rgba(219, 234, 254, 0.8); /* Fondo azul claro semi-transparente */
            font-weight: 600;
            color: #1e3a8a; /* Azul oscuro para texto de encabezado */
            padding: 8px 6px; /* Padding encabezado normal */
        }
        /* Estilo para los selectores (vista normal) */
        td select {
            width: 100%;
            padding: 5px 4px; /* Padding ajustado */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 0.8rem; /* Tamaño fuente select reducido */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            -webkit-appearance: none; /* Quita apariencia nativa en Webkit */
            -moz-appearance: none; /* Quita apariencia nativa en Firefox */
            appearance: none; /* Quita apariencia nativa estándar */
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.4rem center;
            background-size: 1em;
            padding-right: 1.8rem; /* Espacio para la flecha */
        }
        td select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5); /* Borde azul al enfocar */
            background-color: rgba(255, 255, 255, 0.4);
        }
        /* Estilo para la fila de receso */
        .recess-row th, .recess-row td {
            background-color: rgba(254, 243, 199, 0.8) !important; /* bg-yellow-100 con opacidad */
            color: #92400e !important; /* text-yellow-800 */
            font-weight: 600 !important;
        }
        /* Ajuste tamaño fuente horas editables (vista normal) */
        .time-slot {
            font-size: 0.7rem; /* Tamaño reducido */
        }
        /* Estilos Header Vista Normal (Flexbox para consistencia) */
        header.view-header {
            display: flex;
            flex-direction: column; /* Apilado por defecto */
            align-items: center; /* Centrado por defecto */
            text-align: center;
            border-bottom: 1px solid #ccc; /* Borde inferior */
            padding-bottom: 0.75rem; /* Espaciado inferior */
            margin-bottom: 1rem; /* Margen inferior */
        }
        @media (min-width: 768px) { /* md breakpoint */
            header.view-header {
                flex-direction: row; /* Fila en pantallas medianas y grandes */
                justify-content: space-between;
                text-align: left;
            }
            .view-header .header-text-container {
                text-align: center; /* Mantiene texto centrado incluso en fila */
                flex-grow: 1; /* Permite que ocupe espacio */
                margin: 0 1rem; /* Margen horizontal */
            }
            .view-header .header-logo-container {
                margin-bottom: 0; /* Quita margen inferior en vista de fila */
                flex-shrink: 0; /* Evita que se encoja */
            }
             .view-header .header-tic-container {
                margin-top: 0; /* Quita margen superior en vista de fila */
                 flex-shrink: 0; /* Evita que se encoja */
            }
        }

    </style>
</head>
<body class="p-4 md:p-6">

    <div id="schedule-container" class="max-w-6xl w-full mx-auto bg-white bg-opacity-80 backdrop-blur-sm p-4 md:p-6 rounded-lg shadow-xl">

        <header class="view-header">
            <div class="header-logo-container flex items-center space-x-3 mb-3 md:mb-0 flex-shrink-0">
                <img src="sello.jpg" alt="Sello del Colegio" class="w-14 h-14 md:w-16 md:h-16 rounded-full object-cover border-2 border-blue-200" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e2e8f0/64748b?text=Sello';">
            </div>
            <div class="header-text-container">
                <h1 class="text-base md:text-xl font-bold text-blue-800 font-graduate">UNIDAD EDUCATIVA</h1>
                <h2 class="text-xl md:text-2xl font-bold text-blue-900 font-graduate">DR. CAMILO GALLEGOS DOMINGUEZ</h2>
                <p class="text-sm md:text-lg text-blue-700 mt-1">Tutor/a: Msc. Maricela Cun Rueda</p>
            </div>
            <div class="header-tic-container flex-shrink-0 mt-3 md:mt-0">
                <img src="tic.jpg" alt="Imagen TIC" class="w-28 h-auto md:w-32 rounded-md object-cover shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/128/dbeafe/1e3a8a?text=TIC+Error';">
            </div>
        </header>

        <h3 class="text-xl font-semibold text-center text-gray-800 mb-4">Horario de Clases</h3>

        <div class="overflow-x-auto mb-4">
            <table id="schedule-table" class="min-w-full bg-white bg-opacity-90 rounded-md shadow">
                <thead class="bg-blue-100">
                    <tr>
                        <th class="w-[10%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Hora</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Lunes</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Martes</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Miércoles</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Jueves</th>
                        <th class="w-[18%] py-2 px-1 text-xs md:text-sm font-semibold text-blue-900 uppercase tracking-wider">Viernes</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 text-xs">
                    <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 1 <br><span contenteditable="true" class="font-normal time-slot">(12:40-13:20)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                    <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 2 <br><span contenteditable="true" class="font-normal time-slot">(13:20-14:00)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 3 <br><span contenteditable="true" class="font-normal time-slot">(14:00-14:40)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 4 <br><span contenteditable="true" class="font-normal time-slot">(14:40-15:20)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                    <tr class="recess-row">
                        <th scope="row" class="font-semibold py-2 px-1">RECESO <br><span contenteditable="true" class="font-normal time-slot">(15:20-15:50)</span></th>
                        <td colspan="5" class="text-center font-semibold py-2 px-1">TIEMPO DE DESCANSO ESTUDIANTIL</td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 5 <br><span contenteditable="true" class="font-normal time-slot">(15:50-16:30)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 6 <br><span contenteditable="true" class="font-normal time-slot">(16:30-17:10)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 7 <br><span contenteditable="true" class="font-normal time-slot">(17:10-17:50)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                     <tr>
                        <th scope="row" class="font-semibold bg-blue-50 py-2 px-1">Hora 8 <br><span contenteditable="true" class="font-normal time-slot">(17:50-18:30)</span></th>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                        <td><select class="subject-select"></select></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4 mt-4 no-print">
            <button id="download-excel" class="w-full sm:w-auto bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center space-x-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span>Descargar Excel</span>
            </button>
            <button id="print-schedule" class="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center space-x-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    <path d="M7 11h6v1H7v-1z"/>
                </svg>
                <span>Imprimir Horario</span>
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Selección de elementos del DOM
            const scheduleContainer = document.getElementById('schedule-container');
            const downloadExcelButton = document.getElementById('download-excel');
            const printButton = document.getElementById('print-schedule');
            const subjectSelects = document.querySelectorAll('select.subject-select');
            const editableTimeSlots = document.querySelectorAll('.time-slot');
            const scheduleTable = document.getElementById('schedule-table');
            const headerElement = document.querySelector('header.view-header');

            // --- Opciones para los menús desplegables ---
            const subjectOptions = [
                "", // Opción vacía por defecto
                "Programación Y bases de datos \"A\"",
                "Programación y Bases de datos \"B\"",
                "Soporte Técnico \"A\"",
                "Soporte Técnico \"B\"",
                "Sistema Operativo y Redes \"A\"",
                "Sistema Operativo y Redes \"B\"",
                "Acompañamiento Integral"
            ];

            // --- Poblar los menús desplegables y cargar/guardar selección ---
            subjectSelects.forEach((selectElement, index) => {
                subjectOptions.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText || "--- Seleccionar ---";
                    selectElement.appendChild(option);
                });
                selectElement.id = `select_cell_${index}`; // ID único
                const savedValue = localStorage.getItem(selectElement.id); // Cargar valor
                if (savedValue) {
                    selectElement.value = savedValue;
                }
                selectElement.addEventListener('change', () => { // Guardar al cambiar
                    localStorage.setItem(selectElement.id, selectElement.value);
                });
            });

            // --- Funcionalidad del Botón Descargar Excel ---
            downloadExcelButton.addEventListener('click', () => {
                console.log('Iniciando descarga Excel...');
                // ** Añadido Try...Catch para manejo de errores **
                try {
                    saveTimeSlots(); // Guardar horas editables antes de exportar

                    // --- Preparar datos para la hoja de cálculo ---
                    const data = [];

                    // 1. Añadir Encabezado (Títulos, Tutor, etc.)
                    const headerTextContainer = headerElement?.querySelector('.header-text-container'); // Más seguro con ?
                    const h1Text = headerTextContainer?.querySelector('h1')?.textContent.trim() || '';
                    const h2Text = headerTextContainer?.querySelector('h2')?.textContent.trim() || '';
                    const pText = headerTextContainer?.querySelector('p')?.textContent.trim() || '';
                    const scheduleTitle = scheduleContainer.querySelector('h3')?.textContent.trim() || 'Horario de Clases';

                    // Añadir filas de encabezado al array 'data'
                    data.push([h1Text]);
                    data.push([h2Text]);
                    data.push([pText]);
                    data.push([]); // Fila vacía como separador
                    data.push([scheduleTitle]);
                    data.push([]); // Fila vacía como separador

                    // 2. Añadir Cabecera de la Tabla (Hora, Lunes, Martes...)
                    const headerRow = [];
                    // Verifica que la tabla y thead existan
                    if (!scheduleTable || !scheduleTable.tHead) {
                         console.error("Error: No se encontró la tabla o su encabezado (thead).");
                         alert("Error al procesar la tabla para Excel.");
                         return; // Detener ejecución si falta la cabecera
                    }
                    scheduleTable.tHead.querySelectorAll('th').forEach(th => {
                        headerRow.push(th.textContent.trim());
                    });
                    if (headerRow.length > 0) {
                        data.push(headerRow);
                    } else {
                        console.error("No se pudo extraer la cabecera de la tabla.");
                        alert("Error al procesar la cabecera de la tabla para Excel.");
                        return; // Detener si no hay cabecera
                    }

                    // 3. Añadir Filas de Datos de la Tabla (tbody)
                    // Verifica que tbody exista
                     if (!scheduleTable.tBodies || scheduleTable.tBodies.length === 0) {
                        console.warn("Advertencia: No se encontró el cuerpo (tbody) de la tabla.");
                        // Podría continuar y exportar solo el encabezado, o detenerse.
                        // Por ahora, continuaremos, pero mostraremos una advertencia si no hay datos.
                    }
                    const tableBodyRows = scheduleTable.tBodies[0]?.querySelectorAll('tr') || []; // Usar tbody[0]

                    if (tableBodyRows.length === 0) {
                         console.warn("El cuerpo de la tabla está vacío.");
                         // Considerar mostrar una alerta si no hay filas de datos
                         // alert("No hay datos en el horario para exportar.");
                         // return; // Podrías detener aquí si prefieres no exportar tablas vacías
                    }

                    tableBodyRows.forEach((tr) => {
                        const rowData = [];
                        // Celda de la Hora (TH en tbody)
                        const th = tr.querySelector('th');
                        if (th) {
                            const hourText = th.childNodes[0]?.nodeValue?.trim() || ''; // Texto "Hora X"
                            const timeSlotSpan = th.querySelector('.time-slot');
                            const timeText = timeSlotSpan ? timeSlotSpan.textContent.trim() : '';
                            rowData.push(`${hourText}\n${timeText}`); // Combina con salto de línea para Excel
                        } else {
                            rowData.push(''); // Celda vacía si no hay 'th' en esta fila
                        }

                        // Celdas de Materias (TD en tbody)
                        const tds = tr.querySelectorAll('td');
                        tds.forEach((td) => {
                            if (td.colSpan === 5) { // Celda de Receso
                                rowData.push(td.textContent.trim());
                                // Añadir celdas vacías para las columnas combinadas
                                for (let i = 0; i < 4; i++) rowData.push("");
                            } else {
                                const select = td.querySelector('select.subject-select');
                                if (select) {
                                    // Acceso más seguro a la opción seleccionada
                                    const selectedOption = select.options[select.selectedIndex];
                                    const selectedText = selectedOption ? selectedOption.text : '';
                                    rowData.push(selectedText === "--- Seleccionar ---" ? "" : selectedText);
                                } else {
                                    // Si no es receso y no hay select, añadir el texto (si lo hubiera)
                                    rowData.push(td.textContent.trim());
                                }
                            }
                        });

                        // Asegurar que la fila tenga el número correcto de columnas
                        const expectedColumns = headerRow.length;
                        while (rowData.length < expectedColumns) {
                            rowData.push('');
                        }
                         // Solo añadir la fila si contiene datos significativos (evita filas completamente vacías)
                         if(rowData.some(cell => cell !== '')) {
                            data.push(rowData);
                         }
                    });

                    // Verificar si se añadieron datos además del encabezado
                    if (data.length <= 7) { // 6 filas de encabezado + 1 fila de cabecera tabla = 7
                        console.warn("No se encontraron datos en las filas del horario para exportar.");
                        alert("El horario parece estar vacío. No se generó el archivo Excel.");
                        return; // No generar archivo si no hay datos
                    }


                    // --- Crear Hoja de Cálculo (Worksheet) y Libro (Workbook) ---
                    const worksheet = XLSX.utils.aoa_to_sheet(data);

                    // --- Ajustar Ancho de Columnas (Mejora visual) ---
                    const colWidths = data[6].map(() => ({ wch: 15 })); // Ancho base usando la fila de cabecera (índice 6)
                    data.forEach(row => {
                        row.forEach((cell, i) => {
                            const cellContent = cell ? cell.toString() : '';
                            // Considerar saltos de línea para el ancho
                            const lines = cellContent.split('\n');
                            const maxLineLength = lines.reduce((max, line) => Math.max(max, line.length), 0);
                            const len = maxLineLength;

                            if (colWidths[i] === undefined) colWidths[i] = { wch: 10 }; // Por si acaso

                            if (colWidths[i].wch < len) {
                                // Ajustar ancho si el contenido es más largo, con un mínimo y padding
                                colWidths[i] = { wch: Math.max(15, len + 3) };
                            }
                        });
                    });
                    colWidths[0] = { wch: 20 }; // Ancho específico para la columna 'Hora'
                    worksheet['!cols'] = colWidths;

                    // --- Combinar Celdas (Merges) ---
                    const merges = [];
                    const numCols = headerRow.length > 0 ? headerRow.length - 1 : 5; // Usar número real de columnas
                    // Combinar celdas del encabezado principal
                    if (data[0]?.[0]) merges.push({ s: { r: 0, c: 0 }, e: { r: 0, c: numCols } }); // Fila 1
                    if (data[1]?.[0]) merges.push({ s: { r: 1, c: 0 }, e: { r: 1, c: numCols } }); // Fila 2
                    if (data[2]?.[0]) merges.push({ s: { r: 2, c: 0 }, e: { r: 2, c: numCols } }); // Fila 3
                    if (data[4]?.[0]) merges.push({ s: { r: 4, c: 0 }, e: { r: 4, c: numCols } }); // Fila 5 (Título Horario)

                    // Combinar celda de Receso (buscarla en los datos procesados)
                    const recessRowIndexInData = data.findIndex(row => row.some(cell => typeof cell === 'string' && cell.includes('RECESO')));
                    if (recessRowIndexInData > -1) {
                         // Encontrar la columna donde empieza el texto del receso
                        const recessColIndex = data[recessRowIndexInData].findIndex(cell => typeof cell === 'string' && cell.includes('TIEMPO DE DESCANSO'));
                         if (recessColIndex > -1) {
                            // Combinar desde esa columna hasta la última
                            merges.push({ s: { r: recessRowIndexInData, c: recessColIndex }, e: { r: recessRowIndexInData, c: numCols } });
                        }
                    }
                    worksheet['!merges'] = merges; // Aplicar las combinaciones

                    // --- Crear Libro y Descargar Archivo ---
                    const workbook = XLSX.utils.book_new(); // Crear libro
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Horario"); // Añadir hoja

                    const fileName = 'horario_clases_camilo_gallegos.xlsx'; // Nombre del archivo
                    XLSX.writeFile(workbook, fileName); // Iniciar descarga

                    console.log('Excel generado exitosamente.');

                } catch (error) { // ** Bloque Catch para capturar errores **
                    console.error('Error al generar o descargar el archivo Excel:', error);
                    // Mostrar alerta al usuario
                    alert('Ocurrió un error al intentar descargar el horario en formato Excel. Por favor, revise la consola del navegador (F12) para obtener más detalles técnicos.');
                }
            });

            // --- Funcionalidad del Botón Imprimir ---
            printButton.addEventListener('click', () => {
                saveTimeSlots(); // Guardar horas editables
                window.print(); // Abrir diálogo de impresión
            });


            // --- Guardar/Cargar horas editables en localStorage ---
            function saveTimeSlots() {
                editableTimeSlots.forEach((span, index) => {
                    localStorage.setItem(`time_slot_${index}`, span.textContent.trim());
                });
                // console.log("Horas guardadas en localStorage."); // Descomentar para depuración
            }

            function loadTimeSlots() {
                editableTimeSlots.forEach((span, index) => {
                    const savedTime = localStorage.getItem(`time_slot_${index}`);
                     if (savedTime) {
                        span.textContent = savedTime;
                    }
                    // Guardar al perder el foco (blur) o al presionar Enter
                    span.addEventListener('blur', saveTimeSlots);
                    span.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault(); // Evita salto de línea en contenteditable
                            span.blur(); // Simula perder el foco para guardar
                        }
                    });
                });
            }

            // Cargar horas al iniciar la página
            loadTimeSlots();

        }); // Fin de DOMContentLoaded
    </script>

</body>
</html>
